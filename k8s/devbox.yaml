apiVersion: v1
kind: Namespace
metadata:
  name: devbox
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: devbox-workspace
  namespace: devbox
spec:
  accessModes: [ "ReadWriteOnce" ]
  resources:
    requests:
      storage: 20Gi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: devbox
  namespace: devbox
spec:
  replicas: 1
  selector:
    matchLabels:
      app: devbox
  template:
    metadata:
      labels:
        app: devbox
    spec:
      containers:
        - name: devbox
          image: malign/devbox:latest
          imagePullPolicy: IfNotPresent
          command: ["/usr/sbin/sshd", "-D", "-e"]
          ports:
            - name: ssh
              containerPort: 22
          volumeMounts:
            - name: workspace
              mountPath: /workspace
            - name: ssh-home
              mountPath: /home/dev/.ssh
            - name: ssh-keys
              mountPath: /tmp/ssh
              readOnly: true
          securityContext:
            runAsUser: 0
            runAsGroup: 0
            allowPrivilegeEscalation: false
          lifecycle:
            postStart:
              exec:
                command:
                  - /bin/sh
                  - -c
                  - |
                    set -eu
                    install -d -m 700 -o dev -g dev /home/dev/.ssh
                    install -m 600 -o dev -g dev /tmp/ssh/authorized_keys /home/dev/.ssh/authorized_keys
      volumes:
        - name: workspace
          persistentVolumeClaim:
            claimName: devbox-workspace
        - name: ssh-home
          emptyDir: {}
        - name: ssh-keys
          secret:
            secretName: ssh-authorized-keys
            items:
              - key: authorized_keys
                path: authorized_keys
---
apiVersion: v1
kind: Service
metadata:
  name: devbox-ssh
  namespace: devbox
spec:
  type: ClusterIP
  selector:
    app: devbox
  ports:
    - name: ssh
      port: 2222
      targetPort: 22


