# python -m shared_ml.cli.slurm_sweep --account 'ml' --checkpoint_name 'checkpoint_final' --checkpoint_name_sweep 'checkpoint_final' --no-compute_per_module_scores --compute_per_token_scores --covariance_and_lambda_max_examples_sweep '[500]' --cpus_per_task '4' --dependencies '['254550']' --dist_nodes '1' --dist_nproc_per_node 'None' --distributed_timeout '900' --dtype_model 'bf16' --experiment_name 'fp32_run' --factor_batch_size '2' --factor_strategy 'fast-source' --gpus '1' --layers_to_track 'mlp' --memory_gb '320' --nodelist '['concerto1', 'concerto2', 'concerto3']' --nodes '1' --num_module_partitions_covariance '2' --num_module_partitions_lambda '2' --num_module_partitions_scores '1' --num_repeats '1' --output_dir 'outputs' --no-overwrite_output_dir --partition 'ml' --no-profile_computations --query_batch_size '64' --query_dataset_split_name_sweep '['inferred_facts_first_hop_no_fs','inferred_facts_second_hop_no_fs']' --query_gradient_accumulation_steps '10' --query_gradient_rank '64' --queue 'ml' --random_seed '42' --script_name 'run_influence' --slurm_log_dir 'logs' --sweep_logging_type 'wandb' --sweep_name 'inf_across_checkpoints' --sweep_output_dir 'outputs' --sweep_wandb_project 'malign-influence' --target_experiment_dir '/h/319/max/malign-influence-sweep/outputs/2025_07_06_01-49-00_SWEEP_gseH8_pretrain_run_save_epochs_train_extractive/2025_07_06_01-49-20_OIQJO_2025_07_06_01-49-00_SWEEP_gseH8_pretrain_run_save_epochs_train_extractive_index_0_synthetic_docs_hop_pretraining_dataset_num_facts_10_num_epochs_1_lr_0.0001_pretrain_dset_size_2000_repeats_trn_1' --no-torch_distributed --no-torch_distributed_debug --train_batch_size '2' --use_flash_attn --use_half_precision_influence --wandb_project 'malign-influence' --use_half_precision_influence --damping 0.0 --fast_source_lr_sweep '[0.0001,0.01,0.1,1.0,10.0,0.00001]' --fast_source_num_steps 300

# python -m shared_ml.cli.slurm_sweep --account 'ml' --checkpoint_name 'checkpoint_final' --checkpoint_name_sweep 'checkpoint_final' --no-compute_per_module_scores --compute_per_token_scores --covariance_and_lambda_max_examples_sweep '[500]' --cpus_per_task '4' --dependencies '['254550']' --dist_nodes '1' --dist_nproc_per_node 'None' --distributed_timeout '900' --dtype_model 'bf16' --experiment_name 'fp32_run' --factor_batch_size '2' --factor_strategy 'fast-source' --gpus '1' --layers_to_track 'mlp' --memory_gb '320' --nodelist '['concerto1', 'concerto2', 'concerto3']' --nodes '1' --num_module_partitions_covariance '2' --num_module_partitions_lambda '2' --num_module_partitions_scores '1' --num_repeats '1' --output_dir 'outputs' --no-overwrite_output_dir --partition 'ml' --no-profile_computations --query_batch_size '64' --query_dataset_split_name_sweep '['inferred_facts_first_hop_no_fs','inferred_facts_second_hop_no_fs']' --query_gradient_accumulation_steps '10' --query_gradient_rank '64' --queue 'ml' --random_seed '42' --script_name 'run_influence' --slurm_log_dir 'logs' --sweep_logging_type 'wandb' --sweep_name 'inf_across_checkpoints' --sweep_output_dir 'outputs' --sweep_wandb_project 'malign-influence' --target_experiment_dir '/h/319/max/malign-influence-sweep/outputs/2025_07_06_01-49-00_SWEEP_gseH8_pretrain_run_save_epochs_train_extractive/2025_07_06_01-49-20_OIQJO_2025_07_06_01-49-00_SWEEP_gseH8_pretrain_run_save_epochs_train_extractive_index_0_synthetic_docs_hop_pretraining_dataset_num_facts_10_num_epochs_1_lr_0.0001_pretrain_dset_size_2000_repeats_trn_1' --no-torch_distributed --no-torch_distributed_debug --train_batch_size '2' --use_flash_attn --use_half_precision_influence --wandb_project 'malign-influence' --use_half_precision_influence --damping_sweep '[1e-8,1e-6,1e-4,1e-2,1]' --fast_source_num_steps 300 --no-apply_fast_source_lambda_mapping

# python -m shared_ml.cli.slurm_sweep --account 'ml' --checkpoint_name 'checkpoint_final' --checkpoint_name_sweep 'checkpoint_final' --no-compute_per_module_scores --compute_per_token_scores --covariance_and_lambda_max_examples_sweep '[500]' --cpus_per_task '4' --dependencies '['254550']' --dist_nodes '1' --dist_nproc_per_node 'None' --distributed_timeout '900' --dtype_model 'bf16' --experiment_name 'fp32_run' --factor_batch_size '2' --factor_strategy 'fast-source' --gpus '1' --layers_to_track 'mlp' --memory_gb '320' --nodelist '['concerto1', 'concerto2', 'concerto3']' --nodes '1' --num_module_partitions_covariance '2' --num_module_partitions_lambda '2' --num_module_partitions_scores '1' --num_repeats '1' --output_dir 'outputs' --no-overwrite_output_dir --partition 'ml' --no-profile_computations --query_batch_size '64' --query_dataset_split_name_sweep '['inferred_facts_first_hop_no_fs','inferred_facts_second_hop_no_fs']' --query_gradient_accumulation_steps '10' --query_gradient_rank '64' --queue 'ml' --random_seed '42' --script_name 'run_influence' --slurm_log_dir 'logs' --sweep_logging_type 'wandb' --sweep_name 'inf_across_checkpoints' --sweep_output_dir 'outputs' --sweep_wandb_project 'malign-influence' --target_experiment_dir '/h/319/max/malign-influence-sweep/outputs/2025_07_06_01-49-00_SWEEP_gseH8_pretrain_run_save_epochs_train_extractive/2025_07_06_01-49-20_OIQJO_2025_07_06_01-49-00_SWEEP_gseH8_pretrain_run_save_epochs_train_extractive_index_0_synthetic_docs_hop_pretraining_dataset_num_facts_10_num_epochs_1_lr_0.0001_pretrain_dset_size_2000_repeats_trn_1' --no-torch_distributed --no-torch_distributed_debug --train_batch_size '2' --use_flash_attn --use_half_precision_influence --wandb_project 'malign-influence' --use_half_precision_influence --damping 0.0 --fast_source_lr_sweep '[1e-6,1e-5,1e-3,1,10,100]' --fast_source_num_steps 300 --query_name_extra "test_with_caching_fixed_i_hope"


python -m shared_ml.cli.slurm_sweep --account 'ml' --checkpoint_name 'checkpoint_final'  --no-compute_per_module_scores --compute_per_token_scores --covariance_and_lambda_max_examples_sweep '[500]' --cpus_per_task '4' --dependencies '['254550']' --dist_nodes '1' --dist_nproc_per_node 'None' --distributed_timeout '900' --dtype_model 'bf16' --experiment_name 'fp32_run' --factor_batch_size '2' --factor_strategy 'fast-source' --gpus '1' --layers_to_track 'mlp' --memory_gb '320' --nodelist '['concerto1', 'concerto2', 'concerto3']' --nodes '1' --num_module_partitions_covariance '2' --num_module_partitions_lambda '2' --num_module_partitions_scores '1' --num_repeats '1' --output_dir 'outputs' --no-overwrite_output_dir --partition 'ml' --no-profile_computations --query_batch_size '64' --query_dataset_split_names '["second_hop_inferred_fact_gen_no_fs","first_hop_inferred_fact_gen_no_fs","first_hop_inferred_fact_qa_no_fs","second_hop_inferred_fact_qa_no_fs"]' --query_gradient_accumulation_steps '10' --query_gradient_rank '64' --queue 'ml' --random_seed '42' --script_name 'run_influence' --slurm_log_dir 'logs' --sweep_logging_type 'wandb' --sweep_name 'inf_across_checkpoints' --sweep_output_dir 'outputs' --sweep_wandb_project 'malign-influence' --target_experiment_dir '/h/319/max/malign-influence-sweep/outputs/2025_07_10_15-56-03_SWEEP_wgMSx_pretrain_run_save_epochs_train_extractive/2025_07_10_15-56-22_6qixe_2025_07_10_15-56-03_SWEEP_wgMSx_pretrain_run_save_epochs_train_extractive_index_0_cached_synthetic_docs_hop_pretraining_dataset_num_epochs_1_lr_0.0001_pretrain_dset_size_2000_repeats_trn_1' --no-torch_distributed --no-torch_distributed_debug --train_batch_size '2' --use_flash_attn --use_half_precision_influence --wandb_project 'malign-influence' --use_half_precision_influence --damping 0.0 --fast_source_lr_sweep '[1,100]' --fast_source_num_steps 300 --query_name_extra "test_with_caching_fixed_i_hope"